AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation Tag Provider
Parameters:
  LambdaS3Bucket:
    Type: String
    Default: ''
  CFNCustomProviderZipFileName:
    Type: String
    Default: lambdas/cfn-tag-provider-0.1.4.zip
Conditions:
  UsePublicBucket: !Equals
    - !Ref 'LambdaS3Bucket'
    - ''
Resources:
  LambdaPolicy:
    Type: AWS::IAM::Policy
    DependsOn:
      - LambdaRole
    Properties:
      PolicyName: CFNCustomTagProviderPolicy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Sid: ProviderUsed
            Action:
              - tag:GetTagKeys
              - tag:GetTagValues
              - tag:TagResources
              - tag:UntagResources
            Resource:
              - '*'
          - Effect: Allow
            Sid: GeneratedTagActionsFromAPI
            Action:
              - accessanalyzer:ListTagsForResource
              - accessanalyzer:TagResource
              - accessanalyzer:Get*
              - acm:AddTagsToCertificate
              - acm:ListTagsForCertificate
              - acm:RemoveTagsFromCertificate
              - acm:Get*
              - acm-pca:ListTags
              - acm-pca:TagCertificateAuthority
              - acm-pca:Get*
              - alexaforbusiness:ListTags
              - alexaforbusiness:TagResource
              - alexaforbusiness:Get*
              - amplify:ListTagsForResource
              - amplify:TagResource
              - amplify:Get*
              - apigateway:GetTags
              - apigateway:TagResource
              - apigateway:Get*
              - apigatewayv2:GetTags
              - apigatewayv2:TagResource
              - apigatewayv2:Get*
              - appconfig:ListTagsForResource
              - appconfig:TagResource
              - appconfig:Get*
              - appflow:ListTagsForResource
              - appflow:TagResource
              - appflow:Get*
              - appintegrations:ListTagsForResource
              - appintegrations:TagResource
              - appintegrations:Get*
              - application-insights:ListTagsForResource
              - application-insights:TagResource
              - application-insights:Get*
              - appmesh:ListTagsForResource
              - appmesh:TagResource
              - appmesh:Get*
              - apprunner:ListTagsForResource
              - apprunner:TagResource
              - apprunner:Get*
              - appstream:ListTagsForResource
              - appstream:TagResource
              - appstream:Get*
              - appsync:ListTagsForResource
              - appsync:TagResource
              - appsync:Get*
              - athena:ListTagsForResource
              - athena:TagResource
              - athena:Get*
              - auditmanager:ListTagsForResource
              - auditmanager:TagResource
              - auditmanager:Get*
              - autoscaling:CreateOrUpdateTags
              - autoscaling:DeleteTags
              - autoscaling:DescribeTags
              - autoscaling:Get*
              - backup:ListTags
              - backup:TagResource
              - backup:Get*
              - batch:ListTagsForResource
              - batch:TagResource
              - batch:Get*
              - braket:ListTagsForResource
              - braket:TagResource
              - braket:Get*
              - ce:GetTags
              - ce:Get*
              - chime:ListAttendeeTags
              - chime:ListMeetingTags
              - chime:ListTagsForResource
              - chime:TagAttendee
              - chime:TagMeeting
              - chime:TagResource
              - chime:Get*
              - cloud9:ListTagsForResource
              - cloud9:TagResource
              - cloud9:Get*
              - clouddirectory:ListTagsForResource
              - clouddirectory:TagResource
              - clouddirectory:Get*
              - cloudfront:CreateDistributionWithTags
              - cloudfront:CreateStreamingDistributionWithTags
              - cloudfront:ListTagsForResource
              - cloudfront:TagResource
              - cloudfront:Get*
              - cloudhsm:AddTagsToResource
              - cloudhsm:ListTagsForResource
              - cloudhsm:RemoveTagsFromResource
              - cloudhsm:Get*
              - cloudhsmv2:ListTags
              - cloudhsmv2:TagResource
              - cloudhsmv2:Get*
              - cloudtrail:AddTags
              - cloudtrail:ListTags
              - cloudtrail:RemoveTags
              - cloudtrail:Get*
              - cloudwatch:ListTagsForResource
              - cloudwatch:TagResource
              - cloudwatch:Get*
              - codeartifact:ListTagsForResource
              - codeartifact:TagResource
              - codeartifact:Get*
              - codecommit:ListTagsForResource
              - codecommit:TagResource
              - codecommit:Get*
              - codedeploy:AddTagsToOnPremisesInstances
              - codedeploy:ListTagsForResource
              - codedeploy:RemoveTagsFromOnPremisesInstances
              - codedeploy:TagResource
              - codedeploy:Get*
              - codeguru-reviewer:ListTagsForResource
              - codeguru-reviewer:TagResource
              - codeguru-reviewer:Get*
              - codeguruprofiler:ListTagsForResource
              - codeguruprofiler:TagResource
              - codeguruprofiler:Get*
              - codepipeline:ListTagsForResource
              - codepipeline:TagResource
              - codepipeline:Get*
              - codestar:ListTagsForProject
              - codestar:TagProject
              - codestar:Get*
              - codestar-connections:ListTagsForResource
              - codestar-connections:TagResource
              - codestar-connections:Get*
              - codestar-notifications:ListTagsForResource
              - codestar-notifications:TagResource
              - codestar-notifications:Get*
              - cognito-identity:GetPrincipalTagAttributeMap
              - cognito-identity:ListTagsForResource
              - cognito-identity:SetPrincipalTagAttributeMap
              - cognito-identity:TagResource
              - cognito-identity:Get*
              - cognito-idp:ListTagsForResource
              - cognito-idp:TagResource
              - cognito-idp:Get*
              - comprehend:ListTagsForResource
              - comprehend:TagResource
              - comprehend:Get*
              - config:ListTagsForResource
              - config:TagResource
              - config:Get*
              - connect:ListTagsForResource
              - connect:TagResource
              - connect:Get*
              - customer-profiles:ListTagsForResource
              - customer-profiles:TagResource
              - customer-profiles:Get*
              - databrew:ListTagsForResource
              - databrew:TagResource
              - databrew:Get*
              - dataexchange:ListTagsForResource
              - dataexchange:TagResource
              - dataexchange:Get*
              - datapipeline:AddTags
              - datapipeline:RemoveTags
              - datapipeline:Get*
              - datasync:ListTagsForResource
              - datasync:TagResource
              - datasync:Get*
              - dax:ListTags
              - dax:TagResource
              - dax:Get*
              - detective:ListTagsForResource
              - detective:TagResource
              - detective:Get*
              - devicefarm:ListTagsForResource
              - devicefarm:TagResource
              - devicefarm:Get*
              - directconnect:DescribeTags
              - directconnect:TagResource
              - directconnect:Get*
              - discovery:CreateTags
              - discovery:DeleteTags
              - discovery:DescribeTags
              - discovery:Get*
              - dlm:ListTagsForResource
              - dlm:TagResource
              - dlm:Get*
              - dms:AddTagsToResource
              - dms:ListTagsForResource
              - dms:RemoveTagsFromResource
              - dms:Get*
              - docdb:AddTagsToResource
              - docdb:ListTagsForResource
              - docdb:RemoveTagsFromResource
              - docdb:Get*
              - ds:AddTagsToResource
              - ds:ListTagsForResource
              - ds:RemoveTagsFromResource
              - ds:Get*
              - dynamodb:ListTagsOfResource
              - dynamodb:TagResource
              - dynamodb:Get*
              - ec2:CreateTags
              - ec2:DeleteTags
              - ec2:DescribeTags
              - ec2:Get*
              - ecr:ListTagsForResource
              - ecr:PutImageTagMutability
              - ecr:TagResource
              - ecr:Get*
              - ecr-public:DescribeImageTags
              - ecr-public:ListTagsForResource
              - ecr-public:TagResource
              - ecr-public:Get*
              - ecs:ListTagsForResource
              - ecs:TagResource
              - ecs:Get*
              - efs:CreateTags
              - efs:DeleteTags
              - efs:DescribeTags
              - efs:ListTagsForResource
              - efs:TagResource
              - efs:Get*
              - eks:ListTagsForResource
              - eks:TagResource
              - eks:Get*
              - elastic-inference:ListTagsForResource
              - elastic-inference:TagResource
              - elastic-inference:Get*
              - elasticache:AddTagsToResource
              - elasticache:ListTagsForResource
              - elasticache:RemoveTagsFromResource
              - elasticache:Get*
              - elasticbeanstalk:ListTagsForResource
              - elasticbeanstalk:UpdateTagsForResource
              - elasticbeanstalk:Get*
              - elb:AddTags
              - elb:DescribeTags
              - elb:RemoveTags
              - elb:Get*
              - elbv2:AddTags
              - elbv2:DescribeTags
              - elbv2:RemoveTags
              - elbv2:Get*
              - emr:AddTags
              - emr:RemoveTags
              - emr:Get*
              - emr-containers:ListTagsForResource
              - emr-containers:TagResource
              - emr-containers:Get*
              - es:AddTags
              - es:ListTags
              - es:RemoveTags
              - es:Get*
              - events:ListTagsForResource
              - events:TagResource
              - events:Get*
              - finspace:ListTagsForResource
              - finspace:TagResource
              - finspace:Get*
              - firehose:ListTagsForDeliveryStream
              - firehose:TagDeliveryStream
              - firehose:Get*
              - fis:ListTagsForResource
              - fis:TagResource
              - fis:Get*
              - fms:ListTagsForResource
              - fms:TagResource
              - fms:Get*
              - forecast:ListTagsForResource
              - forecast:TagResource
              - forecast:Get*
              - frauddetector:ListTagsForResource
              - frauddetector:TagResource
              - frauddetector:Get*
              - fsx:ListTagsForResource
              - fsx:TagResource
              - fsx:Get*
              - gamelift:ListTagsForResource
              - gamelift:TagResource
              - gamelift:Get*
              - glacier:AddTagsToVault
              - glacier:ListTagsForVault
              - glacier:RemoveTagsFromVault
              - glacier:Get*
              - globalaccelerator:ListTagsForResource
              - globalaccelerator:TagResource
              - globalaccelerator:Get*
              - glue:GetTags
              - glue:TagResource
              - glue:Get*
              - greengrass:ListTagsForResource
              - greengrass:TagResource
              - greengrass:Get*
              - greengrassv2:ListTagsForResource
              - greengrassv2:TagResource
              - greengrassv2:Get*
              - groundstation:ListTagsForResource
              - groundstation:TagResource
              - groundstation:Get*
              - guardduty:ListTagsForResource
              - guardduty:TagResource
              - guardduty:Get*
              - healthlake:ListTagsForResource
              - healthlake:TagResource
              - healthlake:Get*
              - iam:ListInstanceProfileTags
              - iam:ListMFADeviceTags
              - iam:ListOpenIDConnectProviderTags
              - iam:ListPolicyTags
              - iam:ListRoleTags
              - iam:ListSAMLProviderTags
              - iam:ListServerCertificateTags
              - iam:ListUserTags
              - iam:TagInstanceProfile
              - iam:TagMFADevice
              - iam:TagOpenIDConnectProvider
              - iam:TagPolicy
              - iam:TagRole
              - iam:TagSAMLProvider
              - iam:TagServerCertificate
              - iam:TagUser
              - iam:Get*
              - imagebuilder:ListTagsForResource
              - imagebuilder:TagResource
              - imagebuilder:Get*
              - inspector:ListTagsForResource
              - inspector:SetTagsForResource
              - inspector:Get*
              - iot:ListTagsForResource
              - iot:TagResource
              - iot:Get*
              - iot1click-devices:ListTagsForResource
              - iot1click-devices:TagResource
              - iot1click-devices:Get*
              - iot1click-projects:ListTagsForResource
              - iot1click-projects:TagResource
              - iot1click-projects:Get*
              - iotanalytics:ListTagsForResource
              - iotanalytics:TagResource
              - iotanalytics:Get*
              - iotdeviceadvisor:ListTagsForResource
              - iotdeviceadvisor:TagResource
              - iotdeviceadvisor:Get*
              - iotevents:ListTagsForResource
              - iotevents:TagResource
              - iotevents:Get*
              - iotfleethub:ListTagsForResource
              - iotfleethub:TagResource
              - iotfleethub:Get*
              - iotsecuretunneling:ListTagsForResource
              - iotsecuretunneling:TagResource
              - iotsecuretunneling:Get*
              - iotsitewise:ListTagsForResource
              - iotsitewise:TagResource
              - iotsitewise:Get*
              - iotthingsgraph:ListTagsForResource
              - iotthingsgraph:TagResource
              - iotthingsgraph:Get*
              - iotwireless:ListTagsForResource
              - iotwireless:TagResource
              - iotwireless:Get*
              - ivs:ListTagsForResource
              - ivs:TagResource
              - ivs:Get*
              - kafka:ListTagsForResource
              - kafka:TagResource
              - kafka:Get*
              - kendra:ListTagsForResource
              - kendra:TagResource
              - kendra:Get*
              - kinesis:AddTagsToStream
              - kinesis:ListTagsForStream
              - kinesis:RemoveTagsFromStream
              - kinesis:Get*
              - kinesisanalytics:ListTagsForResource
              - kinesisanalytics:TagResource
              - kinesisanalytics:Get*
              - kinesisanalyticsv2:ListTagsForResource
              - kinesisanalyticsv2:TagResource
              - kinesisanalyticsv2:Get*
              - kinesisvideo:ListTagsForResource
              - kinesisvideo:ListTagsForStream
              - kinesisvideo:TagResource
              - kinesisvideo:TagStream
              - kinesisvideo:Get*
              - kms:ListResourceTags
              - kms:TagResource
              - kms:Get*
              - lakeformation:AddLFTagsToResource
              - lakeformation:CreateLFTag
              - lakeformation:DeleteLFTag
              - lakeformation:GetLFTag
              - lakeformation:GetResourceLFTags
              - lakeformation:ListLFTags
              - lakeformation:RemoveLFTagsFromResource
              - lakeformation:SearchDatabasesByLFTags
              - lakeformation:SearchTablesByLFTags
              - lakeformation:UpdateLFTag
              - lakeformation:Get*
              - lambda:ListTags
              - lambda:TagResource
              - lambda:Get*
              - lex-models:ListTagsForResource
              - lex-models:TagResource
              - lex-models:Get*
              - lexv2-models:ListTagsForResource
              - lexv2-models:TagResource
              - lexv2-models:Get*
              - license-manager:ListTagsForResource
              - license-manager:TagResource
              - license-manager:Get*
              - lightsail:TagResource
              - lightsail:Get*
              - location:ListTagsForResource
              - location:TagResource
              - location:Get*
              - logs:ListTagsLogGroup
              - logs:TagLogGroup
              - logs:Get*
              - lookoutequipment:ListTagsForResource
              - lookoutequipment:TagResource
              - lookoutequipment:Get*
              - lookoutmetrics:ListTagsForResource
              - lookoutmetrics:TagResource
              - lookoutmetrics:Get*
              - lookoutvision:ListTagsForResource
              - lookoutvision:TagResource
              - lookoutvision:Get*
              - machinelearning:AddTags
              - machinelearning:DeleteTags
              - machinelearning:DescribeTags
              - machinelearning:Get*
              - macie2:ListTagsForResource
              - macie2:TagResource
              - macie2:Get*
              - managedblockchain:ListTagsForResource
              - managedblockchain:TagResource
              - managedblockchain:Get*
              - mediaconnect:ListTagsForResource
              - mediaconnect:TagResource
              - mediaconnect:Get*
              - mediaconvert:ListTagsForResource
              - mediaconvert:TagResource
              - mediaconvert:Get*
              - medialive:CreateTags
              - medialive:DeleteTags
              - medialive:ListTagsForResource
              - medialive:Get*
              - mediapackage:ListTagsForResource
              - mediapackage:TagResource
              - mediapackage:Get*
              - mediapackage-vod:ListTagsForResource
              - mediapackage-vod:TagResource
              - mediapackage-vod:Get*
              - mediastore:ListTagsForResource
              - mediastore:TagResource
              - mediastore:Get*
              - mediatailor:ListTagsForResource
              - mediatailor:TagResource
              - mediatailor:Get*
              - mgn:ListTagsForResource
              - mgn:TagResource
              - mgn:Get*
              - mq:CreateTags
              - mq:DeleteTags
              - mq:ListTags
              - mq:Get*
              - mwaa:ListTagsForResource
              - mwaa:TagResource
              - mwaa:Get*
              - neptune:AddTagsToResource
              - neptune:ListTagsForResource
              - neptune:RemoveTagsFromResource
              - neptune:Get*
              - network-firewall:ListTagsForResource
              - network-firewall:TagResource
              - network-firewall:Get*
              - networkmanager:ListTagsForResource
              - networkmanager:TagResource
              - networkmanager:Get*
              - nimble:ListTagsForResource
              - nimble:TagResource
              - nimble:Get*
              - opsworks:ListTags
              - opsworks:TagResource
              - opsworks:Get*
              - opsworkscm:ListTagsForResource
              - opsworkscm:TagResource
              - opsworkscm:Get*
              - organizations:ListTagsForResource
              - organizations:TagResource
              - organizations:Get*
              - outposts:ListTagsForResource
              - outposts:TagResource
              - outposts:Get*
              - pinpoint:ListTagsForResource
              - pinpoint:TagResource
              - pinpoint:Get*
              - pinpoint-email:ListTagsForResource
              - pinpoint-email:TagResource
              - pinpoint-email:Get*
              - proton:ListTagsForResource
              - proton:TagResource
              - proton:Get*
              - qldb:ListTagsForResource
              - qldb:TagResource
              - qldb:Get*
              - quicksight:ListTagsForResource
              - quicksight:TagResource
              - quicksight:Get*
              - ram:TagResource
              - ram:Get*
              - rds:AddTagsToResource
              - rds:ListTagsForResource
              - rds:RemoveTagsFromResource
              - rds:Get*
              - redshift:CreateTags
              - redshift:DeleteTags
              - redshift:DescribeTags
              - redshift:Get*
              - rekognition:ListTagsForResource
              - rekognition:TagResource
              - rekognition:Get*
              - resource-groups:GetTags
              - resource-groups:Tag
              - resource-groups:Get*
              - resourcegroupstaggingapi:GetTagKeys
              - resourcegroupstaggingapi:GetTagValues
              - resourcegroupstaggingapi:TagResources
              - resourcegroupstaggingapi:Get*
              - robomaker:ListTagsForResource
              - robomaker:TagResource
              - robomaker:Get*
              - route53:ChangeTagsForResource
              - route53:ListTagsForResource
              - route53:ListTagsForResources
              - route53:Get*
              - route53-recovery-readiness:ListTagsForResources
              - route53-recovery-readiness:TagResource
              - route53-recovery-readiness:Get*
              - route53domains:DeleteTagsForDomain
              - route53domains:ListTagsForDomain
              - route53domains:UpdateTagsForDomain
              - route53domains:Get*
              - route53resolver:ListTagsForResource
              - route53resolver:TagResource
              - route53resolver:Get*
              - s3:DeleteBucketTagging
              - s3:DeleteObjectTagging
              - s3:GetBucketTagging
              - s3:GetObjectTagging
              - s3:PutBucketTagging
              - s3:PutObjectTagging
              - s3:Get*
              - s3control:DeleteBucketTagging
              - s3control:DeleteJobTagging
              - s3control:DeleteStorageLensConfigurationTagging
              - s3control:GetBucketTagging
              - s3control:GetJobTagging
              - s3control:GetStorageLensConfigurationTagging
              - s3control:PutBucketTagging
              - s3control:PutJobTagging
              - s3control:PutStorageLensConfigurationTagging
              - s3control:Get*
              - sagemaker:AddTags
              - sagemaker:DeleteTags
              - sagemaker:ListTags
              - sagemaker:Get*
              - savingsplans:ListTagsForResource
              - savingsplans:TagResource
              - savingsplans:Get*
              - schemas:ListTagsForResource
              - schemas:TagResource
              - schemas:Get*
              - secretsmanager:TagResource
              - secretsmanager:Get*
              - securityhub:ListTagsForResource
              - securityhub:TagResource
              - securityhub:Get*
              - service-quotas:ListTagsForResource
              - service-quotas:TagResource
              - service-quotas:Get*
              - servicecatalog:AssociateTagOptionWithResource
              - servicecatalog:CreateTagOption
              - servicecatalog:DeleteTagOption
              - servicecatalog:DescribeTagOption
              - servicecatalog:DisassociateTagOptionFromResource
              - servicecatalog:ListResourcesForTagOption
              - servicecatalog:ListTagOptions
              - servicecatalog:UpdateTagOption
              - servicecatalog:Get*
              - servicecatalog-appregistry:ListTagsForResource
              - servicecatalog-appregistry:TagResource
              - servicecatalog-appregistry:Get*
              - servicediscovery:ListTagsForResource
              - servicediscovery:TagResource
              - servicediscovery:Get*
              - sesv2:ListTagsForResource
              - sesv2:TagResource
              - sesv2:Get*
              - shield:ListTagsForResource
              - shield:TagResource
              - shield:Get*
              - signer:ListTagsForResource
              - signer:TagResource
              - signer:Get*
              - snow-device-management:ListTagsForResource
              - snow-device-management:TagResource
              - snow-device-management:Get*
              - sns:ListTagsForResource
              - sns:TagResource
              - sns:Get*
              - sqs:ListQueueTags
              - sqs:TagQueue
              - sqs:Get*
              - ssm:AddTagsToResource
              - ssm:ListTagsForResource
              - ssm:RemoveTagsFromResource
              - ssm:Get*
              - ssm-contacts:ListTagsForResource
              - ssm-contacts:TagResource
              - ssm-contacts:Get*
              - ssm-incidents:ListTagsForResource
              - ssm-incidents:TagResource
              - ssm-incidents:Get*
              - sso-admin:ListTagsForResource
              - sso-admin:TagResource
              - sso-admin:Get*
              - stepfunctions:ListTagsForResource
              - stepfunctions:TagResource
              - stepfunctions:Get*
              - storagegateway:AddTagsToResource
              - storagegateway:ListTagsForResource
              - storagegateway:RemoveTagsFromResource
              - storagegateway:Get*
              - swf:ListTagsForResource
              - swf:TagResource
              - swf:Get*
              - synthetics:ListTagsForResource
              - synthetics:TagResource
              - synthetics:Get*
              - timestream-write:ListTagsForResource
              - timestream-write:TagResource
              - timestream-write:Get*
              - transfer:ListTagsForResource
              - transfer:TagResource
              - transfer:Get*
              - waf:ListTagsForResource
              - waf:TagResource
              - waf:Get*
              - waf-regional:ListTagsForResource
              - waf-regional:TagResource
              - waf-regional:Get*
              - wafv2:ListTagsForResource
              - wafv2:TagResource
              - wafv2:Get*
              - wellarchitected:ListTagsForResource
              - wellarchitected:TagResource
              - wellarchitected:Get*
              - worklink:ListTagsForResource
              - worklink:TagResource
              - worklink:Get*
              - workmail:ListTagsForResource
              - workmail:TagResource
              - workmail:Get*
              - workspaces:CreateTags
              - workspaces:DeleteTags
              - workspaces:DescribeTags
              - workspaces:Get*
              - xray:ListTagsForResource
              - xray:TagResource
              - xray:Get*
            Resource:
              - '*'
      Roles:
        - !Ref 'LambdaRole'
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
  CFNTagProvider:
    Type: AWS::Lambda::Function
    DependsOn:
      - LambdaRole
    Properties:
      Description: CloudFormation Tag Provider
      Code:
        S3Bucket: !If
          - UsePublicBucket
          - !Sub 'binxio-public-${AWS::Region}'
          - !Ref 'LambdaS3Bucket'
        S3Key: !Ref 'CFNCustomProviderZipFileName'
      FunctionName: cfn-tag-provider
      Handler: provider.handler
      Timeout: 600
      MemorySize: 128
      Role: !GetAtt 'LambdaRole.Arn'
      Runtime: python3.7
